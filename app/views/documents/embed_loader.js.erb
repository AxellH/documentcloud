<%
  server_root = DC.server_root(agnostic: true)
  asset_root  = DC.asset_root(agnostic: true)
%>
(function() {
  window.DV               = window.DV || {};
  window.DV.documentQueue = window.DV.documentQueue || [];
  window.DV.recordHit     = "<%= server_root %>/pixel.gif";

  /* `load()` used to be defined in `document_viewer.js`, but we've renamed it
     to `immediatelyLoadDocument()` and turned this into a queuing function. */
  window.DV.load = function(url, options) {
    if (window.DV.immediatelyLoadDocument !== void 0) {
      window.DV.immediatelyLoadDocument(url, options);
    } else {
      /* 1. Define our note-loading utility functions */
      var on = function (el, eventName, handler) {
        if (el.addEventListener) {
          el.addEventListener(eventName, handler);
        } else {
          el.attachEvent('on' + eventName, function() {
            handler.call(el);
          });
        }
      };
      var insertStylesheet = function(href, media) {
        if (!document.querySelector('link[href$="' + href + '"]')) {
          media = media || 'screen';
          var stylesheet       = document.createElement('link');
              stylesheet.rel   = 'stylesheet';
              stylesheet.type  = 'text/css';
              stylesheet.media = media;
              stylesheet.href  = href;
          document.querySelector('head').appendChild(stylesheet);
        }
      };
      var insertJavaScript = function(src, onLoadCallback) {
        if (!document.querySelector('script[src$="' + src + '"]')) {
          var script       = document.createElement('script');
              script.src   = src;
              script.async = true;
          on(script, 'load', onLoadCallback);
          document.querySelector('body').appendChild(script);
        }
      };
      var loadQueuedDocuments = function() {
        var q = window.DV.documentQueue;
        for (var i = 0, qLength = q.length; i < qLength; i++) {
          window.DV.immediatelyLoadDocument(q[i].url, q[i].options);
        }
        window.DV.documentQueue = [];
      };

      /* 2. Add this note to the queue that `loadQueuedDocuments()` will use */
      window.DV.documentQueue.push({url: url, options: options});

      /* 3. Insert the styles and scripts needed, with `loadQueuedDocuments()`
            fired after the script has finished loading */
      /*@cc_on
      /*@if (@_jscript_version < 5.8)
        insertStylesheet('<%= asset_root %>/viewer/viewer.css');
      @else @*/
        insertStylesheet('<%= asset_root %>/viewer/viewer-datauri.css');
      /*@end
      @*/
      insertStylesheet('<%= asset_root %>/viewer/printviewer.css', 'print');

      insertJavaScript('<%= asset_root %>/viewer/viewer.js', loadQueuedDocuments);
    }
  }
})();
